This repository is used to build docker images for [I-Tee](https://github.com/magavdraakon/i-tee) virtual IT laboratory system. Some additional componennts needed to run full system include:

 * Fully working Virtualbox 5.0 installation (inc. extension pack) on host
 * MySQL (or any other database if it works)
 * LDAP server for authentication. DB-based authentication is not supported. Token-based authentication works without LDAP.
 * Guacamole frontend server and Guacamole daemon to let users connect to machines via browser. [`glyptodon/guacamole`](https://github.com/glyptodon/guacamole-docker) and [`glyptodon/guacd`](https://github.com/glyptodon/guacd-docker) do the work if you prefer containerized installations.

Additional recommended components include
 * phpVirtualbox ([`keijokapp/phpvirtualbox`](https://github.com/keijokapp/phpvirtualbox.docker))
 * Proxy server for TLS and greater flexibility.

# Build

```sh
git clone https://github.com/keijokapp/i-tee.docker.git
cd i-tee.docker
git submodule update --init --recursive

# Create revision.txt file to container so I-Tee can show its build commit without using Git. (optional)
git ls-tree dev fs/var/www/i-tee --abbrev | awk '{print $3}' > fs/var/www/i-tee/revision.txt

docker build -t keijokapp/i-tee:latest .
```

# Run

You need to generate SSH key pair to allow I-Tee to use Virtualbox CLI on host. Create dedicated user (e.g. `vbox`) for that. Install created public key to `authorized_keys` of created user and generate `known_hosts` with host's key for container so it can safely communicate with host. There's many ways to do that - easiest would be to create empty `/etc/i-tee/known_host`, run the container with command below *with `ro` flag omitted* on `known_hosts` line and connect to `localhost` once from container so `known_hosts` will be generated by ssh client. Private key generated earlier should be moved to `/etc/i-tee/id_rsa`.

`/var/labs/run` should contain prewritten and generated VM start scripts. `/var/labs/exports` is needed for importing and exporting labs.

```sh
docker run -d \
	--name i-tee \
	--publish "8080:80" \
	--volume /etc/i-tee/config.yaml:/etc/i-tee/config.yaml:ro \
	--volume /etc/i-tee/id_rsa:/root/.ssh/id_rsa:ro \
	--volume /etc/i-tee/known_hosts:/root/.ssh/known_hosts:ro \
	--volume /var/labs/exports:/var/labs/exports \
	--volume /var/labs/run:/var/labs/run \
	keijokapp/i-tee:latest
```


# Configuration

Configuration file is in YAML format and should be mounted to `/etc/i-tee/config.yaml`.

Note that `localhost` or `127.0.0.1` as host for LDAP or database obviously won't work inside container.

```yaml

# Main database configuration for I-Tee
# Follows the format of Rails database.yml
database:
  adapter: "mysql2"
  host: "mysql.local"
  username: "itee"
  password: "itee"
  database: "itee"

# Database configuration used by I-Tee to manipulate Guacamole users and connections
guacamole_database:
  adapter: "mysql2"
  host: "mysql.local"
  username: "guacamole"
  password: "guacamole"
  database: "guacamole"

# Guacamole specific configuration
# Theoretically I-Tee is able to "mostly" survive without Guacamole but it's not extensively tested.
guacamole:
  # URL prefix to Guacamole API used by i-tee to connect to Guacamole frontend
  url_prefix: "https://i-tee-host.local/guacamole"
  # RDP host used by Guacamole server to connect to virtual machines.
  rdp_host: "i-tee-host.local"

# Authentication server
# Follows the format of Rails Devise ldap.yml 
ldap:
  host: "ldap.local"
  port: 389
  ssl: false

  # Bind user and password
  user: "cn=bind-user,dc=local"
  password: "bind-user"
 
  # Attribute used to indentify users by username
  attribute: "uid"
  base: "ou=users,dc=local"

  # (never really understood what this is for)
  group_base: "ou=groups,dc=local"

# List of fixed usernames of admins/managers
admins: [ ]
managers: [ ]

# Layout theme
skin: "EIK"

# Hostname used to connect to virtual machines directly via RDP (shown to user)
rdp_host: "i-tee-host.local"

# Development mode (defaults to false). Development mode
# enables class reloading, debug log and developer
# friendlier errors in HTTP responses.
development: true
```
