#!/usr/bin/env ruby

#
# @author Keijo Kapp <keijo.kapp@rangeforce.com>
# @license MIT
#
# i-tee docker container startup script
# Assembles i-tee configuration files (database.yml and ldap.yml)
# from /etc/i-tee/config.yml and executes Apache server
#



require 'yaml'

if File.executable?('/usr/local/bin/checkout.sh')
	
	puts `/usr/local/bin/checkout.sh`

	if $?.exitstatus != 0
        	exit $?.exitstatus
	end

end


configFile = YAML.load_file("/etc/i-tee/config.yaml")

databaseConfig = { }
ldapConfig = { }

if not configFile.key?('database')

	STDERR.puts 'Database configuration missing. Using internal sqlite3 configuration.'
	
	databaseConfig['production'] = {
		"adapter" => 'sqlite3',
		"database" => 'db/production.sqlite3'
	};

else

	databaseConfig['production'] = configFile['database'];

	if ENV.key?('ITEE_DATABASE_PASSWORD')
		databaseConfig['production']['password'] = ENV['ITEE_DATABASE_PASSWORD']
	end

end


if not configFile.key?('ldap')

	STDERR.puts 'LDAP configuration missing. Cannot continue.'
	exit 1

else 

	ldapConfig['production'] = {
		"host" => configFile['ldap']['host'],
		"port" => configFile['ldap']['port'],
		"attribute" => configFile['ldap'].key?('attribute') ? configFile['ldap']['attribute'] : 'uid',
		"base" => configFile['ldap']['base'],
		"ssl" => configFile['ldap']['ssl'] ? true : false,
		"admin_user" => configFile['ldap']['user'],
		"admin_password" => ENV.key?('ITEE_LDAP_PASSWORD') ? ENV['ITEE_LDAP_PASSWORD']
		                                                   : configFile['ldap']['password'],
		"group_base" => configFile['ldap']['group_base'],
		"require_attribute" => {
			"objectClass" => 'inetOrgPerson',
			"authorizationRole" => 'postsAdmin'
		}
	}

end


File.open('/var/www/i-tee/config/database.yml', 'w') do |f|
	f.write '# Autogenerated\n\n' + databaseConfig.to_yaml
end

File.open('/var/www/i-tee/config/ldap.yml', 'w') do |f|
	f.write '# Autogenerated\n\n' + ldapConfig.to_yaml
end


puts `su - -s /bin/sh www-data -c 'cd /var/www/i-tee && bundle install && rake db:migrate RAILS_ENV="production" && rake db:seed RAILS_ENV="production"'`

if $?.exitstatus != 0
	exit $?.exitstatus
end

Kernel.exec('/usr/local/bin/run-services.sh')
