#!/usr/bin/env ruby

#
# @author Keijo Kapp <keijo.kapp@rangeforce.com>
# @license MIT
#
# i-tee docker container startup script
# Assembles i-tee configuration files (database.yml and ldap.yml)
# from /etc/i-tee/config.yml and executes Apache server
#



require 'yaml'

configFile = YAML.load_file("/etc/i-tee/config.yml")

databaseConfig = { }
ldapConfig = { }

if not configFile.key?('mysql')
	
	STDERR.puts 'Database configuration missing. Using internal sqlite3 configuration.'
	
	databaseConfig['production'] = {
		"adapter" => 'sqlite3',
		"database" => 'db/production.sqlite3'
	};

else

	databaseConfig['production'] = {
		"adapter" => 'mysql',
		"database" => configFile['mysql']['database'],
		"username" => configFile['mysql']['username'],
		"password" => configFile['mysql']['password'],
	}

end


if not configFile.key?('ldap')

	STDERR.puts 'LDAP configuration missing. Cannot continue.'
	exit 1

else 

	ldapConfig['production'] = {
		"host" => configFile['ldap']['host'],
		"port" => configFile['ldap']['port'],
		"attribute" => configFile['ldap'].key?('attribute') ? configFile['ldap']['attribute'] : 'uid',
		"base" => configFile['ldap']['base'],
		"ssl" => configFile['ldap']['ssl'] ? true : false,
		"admin_user" => configFile['ldap']['admin_user'],
		"admin_password" => configFile['ldap']['admin_password'],
		"group_base" => configFile['ldap']['group_base'],
		"require_attribute" => {
			"objectClass" => 'inetOrgPerson',
			"authorizationRole" => 'postsAdmin'
		}
	}

end

File.delete('/etc/ssl/private/i-tee.key') if File.exist?('/etc/ssl/private/i-tee.key')
File.delete('/etc/ssl/certs/i-tee.pem') if File.exist?('/etc/ssl/certs/i-tee.pem')

if File.exist?('/etc/i-tee/i-tee.key') and File.exist?('/etc/i-tee/i-tee.pem')

	File.symlink('/etc/i-tee/i-tee.key', '/etc/ssl/private/i-tee.key')
	File.symlink('/etc/i-tee/i-tee.pem', '/etc/ssl/certs/i-tee.pem')

else

	STDERR.puts 'WARNING: Using snakeoil SSL key pair'

	File.symlink('/etc/ssl/private/ssl-cert-snakeoil.key', '/etc/ssl/private/i-tee.key')
	File.symlink('/etc/ssl/certs/ssl-cert-snakeoil.pem', '/etc/ssl/certs/i-tee.pem')

end


File.open('/var/www/i-tee/config/database.yml', 'w') do |f|
	f.write databaseConfig.to_yaml
end

File.open('/var/www/i-tee/config/ldap.yml', 'w') do |f|
	f.write ldapConfig.to_yaml
end

`su - -s /bin/sh www-data -c 'cd /var/www/i-tee && rake db:migrate RAILS_ENV="production" && rake db:seed RAILS_ENV="production"'`

if $?.exitstatus != 0
	exit $?.exitstatus
end

`/usr/local/bin/run-services.sh`

exit $?.exitstatus
